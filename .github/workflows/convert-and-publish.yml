name: Convert and Publish CAD Files

on:
  workflow_dispatch:

env:
  TARGET_REPOS: |
    system76/virgo
    byrantech/laptop

jobs:
  convert-models:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create output directories
        run: |
          mkdir -p public/models/virgo
          mkdir -p public/models/anyon_e

      - name: Install Blender
        run: |
          sudo apt update
          sudo snap install blender --classic

      - name: Install FreeCAD
        run: |
          echo "Installing FreeCAD..."
          if sudo apt install -y freecad; then
            echo "FreeCAD installed via apt"
          else
            echo "apt failed, trying snap"
            sudo snap install freecad
          fi
          which freecad || echo "freecad not found in PATH"

      - name: Install gltf-transform CLI
        run: |
          npm install -g @gltf-transform/cli

      - name: Create conversion scripts
        run: |
          # Create Blender conversion script
          cat > blender_convert.py << 'EOF'
          import bpy
          import sys

          bpy.ops.object.select_all(action='SELECT')
          bpy.ops.object.delete()

          input_file = sys.argv[-2]
          output_file = sys.argv[-1]

          try:
              if input_file.lower().endswith('.stl'):
                  bpy.ops.import_mesh.stl(filepath=input_file)
              elif input_file.lower().endswith('.obj'):
                  bpy.ops.import_scene.obj(filepath=input_file)
              else:
                  print(f"Unsupported file type: {input_file}")
                  sys.exit(1)

              bpy.ops.object.select_all(action='SELECT')

              bpy.ops.export_scene.gltf(
                  filepath=output_file,
                  export_format='GLB',
                  use_selection=True,
                  export_materials='EXPORT',
                  export_colors=True,
                  export_cameras=False,
                  export_lights=False
              )

              print(f"Successfully converted {input_file} to {output_file}")

          except Exception as e:
              print(f"Blender conversion failed: {e}")
              sys.exit(1)
          EOF

          # Create FreeCAD conversion script
          cat > freecad_convert.py << 'EOF'
          import sys
          import os
          try:
              import FreeCAD
              import Import
              import Mesh
          except ImportError as e:
              print(f"FreeCAD modules not available: {e}")
              sys.exit(1)

          if len(sys.argv) < 3:
              print("Usage: freecad_convert.py <input_step> <output_stl>")
              sys.exit(1)

          input_path = sys.argv[1]
          output_path = sys.argv[2]

          try:
              print(f"Loading: {input_path}")

              doc = FreeCAD.newDocument("conversion")
              Import.insert(input_path, doc.Name)

              objects = doc.Objects
              print(f"Found {len(objects)} objects")

              if not objects:
                  print("No objects found in STEP file")
                  sys.exit(1)

              mesh_objects = []
              for obj in objects:
                  if hasattr(obj, 'Shape') and obj.Shape:
                      print(f"Processing object: {obj.Label}")
                      try:
                          mesh = doc.addObject("Mesh::Feature", "mesh_" + obj.Label)
                          mesh.Mesh = Mesh.Mesh(obj.Shape.tessellate(0.1))
                          mesh_objects.append(mesh)
                      except Exception as e:
                          print(f"Failed to mesh object {obj.Label}: {e}")
                          continue

              if not mesh_objects:
                  print("No meshable objects found")
                  sys.exit(1)

              print(f"Exporting to: {output_path}")
              mesh_objects[0].Mesh.write(output_path)

              print("Conversion successful")

          except Exception as e:
              import traceback
              print(f"Error during conversion: {e}")
              traceback.print_exc()
              sys.exit(1)
          EOF

      - name: Download and convert System76 Virgo files
        run: |
          echo "=== Processing System76 Virgo ==="
          success=0
          failure=0

          declare -A files=(
            ["pcb-keyboard/models/CPG142501DXX v3.step"]="CPG142501DXX_v3"
            ["pcb-keyboard/models/CPG142501DXX_keycap.step"]="CPG142501DXX_keycap"
            ["pcb-keyboard/models/LED_1515.step"]="LED_1515"
            ["pcb-keyboard/models/Sprintek Nub v9.step"]="Sprintek_Nub_v9"
            ["pcb-rpl-uph/models/c-2-1734839-4-c-3d.stp"]="connector"
            ["pcb-rpl-uph/models/1003-002-01100.stp"]="mb_connector"
            ["pcb-rpl-uph/models/PTN5110.step"]="PTN5110"
          )

          for path in "${!files[@]}"; do
            name="${files[$path]}"
            url="https://raw.githubusercontent.com/system76/virgo/main/${path}"
            temp_file="/tmp/${name}.tmp"
            output_file="public/models/virgo/${name}.glb"

            echo "Downloading: $url"
            if curl -L -f -o "$temp_file" "$url"; then
              size=$(stat -c%s "$temp_file")
              if [[ $size -lt 100 ]]; then
                echo "SKIP: File too small, likely LFS pointer"
                rm -f "$temp_file"
                continue
              fi

              if [[ "$path" == *.step ]] || [[ "$path" == *.stp ]]; then
                stl_temp="/tmp/${name}.stl"
                echo "Converting STEP to STL with FreeCAD..."
                if freecad -c freecad_convert.py "$temp_file" "$stl_temp"; then
                  echo "Converting STL to GLB with Blender..."
                  if blender --background --python blender_convert.py -- "$stl_temp" "$output_file"; then
                    echo "✅ Success: $name"
                    ((success++))
                    rm -f "$stl_temp"
                  else
                    echo "❌ Blender failed: $name"
                    ((failure++))
                  fi
                else
                  echo "❌ FreeCAD failed: $name"
                  ((failure++))
                fi
              elif [[ "$path" == *.stl ]] || [[ "$path" == *.obj ]]; then
                echo "Converting STL/OBJ to GLB with Blender..."
                if blender --background --python blender_convert.py -- "$temp_file" "$output_file"; then
                  echo "✅ Success: $name"
                  ((success++))
                else
                  echo "❌ Failed: $name"
                  ((failure++))
                fi
              fi

              rm -f "$temp_file"
            else
              echo "❌ Download failed: $url"
              ((failure++))
            fi
          done

          echo "Virgo results: $success success, $failure failed"

      - name: Download and convert ANYON_E files
        run: |
          echo "=== Processing ANYON_E ==="
          success=0
          failure=0

          declare -A files=(
            ["motherboard/CM3588 3D/CM3588.stl"]="CM3588"
            ["motherboard/CM3588 3D/CM3588.obj"]="CM3588_obj"
            ["motherboard/CM3588 3D/CM3588_3D.step"]="CM3588_3D"
            ["library/2230_RT8852BE.step"]="wifi_card"
            ["library/2242_SSD.step"]="ssd_2242"
            ["library/2280_SSD.step"]="ssd_2280"
            ["library/DF40C-100DS.stp"]="board_connector"
            ["library/LPJM4938GENL.STEP"]="ethernet_jack"
          )

          for path in "${!files[@]}"; do
            name="${files[$path]}"
            url="https://raw.githubusercontent.com/byrantech/laptop/main/${path}"
            temp_file="/tmp/${name}.tmp"
            output_file="public/models/anyon_e/${name}.glb"

            echo "Downloading: $url"
            if curl -L -f -o "$temp_file" "$url"; then
              size=$(stat -c%s "$temp_file")
              if [[ $size -lt 100 ]]; then
                echo "SKIP: File too small, likely LFS pointer"
                rm -f "$temp_file"
                continue
              fi

              if [[ "$path" == *.step ]] || [[ "$path" == *.stp ]] || [[ "$path" == *.STEP ]]; then
                stl_temp="/tmp/${name}.stl"
                echo "Converting STEP to STL with FreeCAD..."
                if freecad -c freecad_convert.py "$temp_file" "$stl_temp"; then
                  echo "Converting STL to GLB with Blender..."
                  if blender --background --python blender_convert.py -- "$stl_temp" "$output_file"; then
                    echo "✅ Success: $name"
                    ((success++))
                    rm -f "$stl_temp"
                  else
                    echo "❌ Blender failed: $name"
                    ((failure++))
                  fi
                else
                  echo "❌ FreeCAD failed: $name"
                  ((failure++))
                fi
              elif [[ "$path" == *.stl ]] || [[ "$path" == *.obj ]]; then
                echo "Converting STL/OBJ to GLB with Blender..."
                if blender --background --python blender_convert.py -- "$temp_file" "$output_file"; then
                  echo "✅ Success: $name"
                  ((success++))
                else
                  echo "❌ Failed: $name"
                  ((failure++))
                fi
              fi

              rm -f "$temp_file"
            else
              echo "❌ Download failed: $url"
              ((failure++))
            fi
          done

          echo "ANYON_E results: $success success, $failure failed"

      - name: Create fallback models if needed
        run: |
          total=$(find public/models -name "*.glb" | wc -l)
          if [[ $total -eq 0 ]]; then
            echo "No models converted, creating demos..."

            cat > demo_virgo.py << 'EOF'
          import bpy
          bpy.ops.object.select_all(action='SELECT')
          bpy.ops.object.delete()
          bpy.ops.mesh.primitive_cube_add(size=2, location=(0, 0, 0))
          laptop = bpy.context.active_object
          laptop.name = "Demo_Virgo"
          laptop.scale = (3, 2, 0.1)
          bpy.ops.export_scene.gltf(filepath='public/models/virgo/demo_laptop.glb', export_format='GLB')
          EOF

            cat > demo_anyon.py << 'EOF'
          import bpy
          bpy.ops.object.select_all(action='SELECT')
          bpy.ops.object.delete()
          bpy.ops.mesh.primitive_cube_add(size=2, location=(0, 0, 0))
          board = bpy.context.active_object
          board.name = "Demo_Motherboard"
          board.scale = (4, 3, 0.05)
          bpy.ops.export_scene.gltf(filepath='public/models/anyon_e/demo_motherboard.glb', export_format='GLB')
          EOF

            blender --background --python demo_virgo.py
            blender --background --python demo_anyon.py
            echo "Created demo models"
          fi

      - name: Generate manifest
        run: |
          cat > public/models/manifest.json << 'EOF'
          {
            "generated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repositories": {
              "virgo": {
                "name": "System76 Virgo",
                "description": "Open source laptop design by System76",
                "repository": "https://github.com/system76/virgo",
                "models": []
              },
              "anyon_e": {
                "name": "ANYON_E Laptop",
                "description": "Open source laptop design by byrantech",
                "repository": "https://github.com/byrantech/laptop",
                "models": []
              }
            }
          }
          EOF

          # Update with actual files found
          virgo_count=$(find public/models/virgo -name "*.glb" | wc -l)
          anyon_count=$(find public/models/anyon_e -name "*.glb" | wc -l)

          echo "Found $virgo_count Virgo models and $anyon_count ANYON_E models"

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add public/models/

          if ! git diff --staged --quiet; then
            git commit -m "Update 3D models from repositories"
            git push
          else
            echo "No changes to commit"
          fi

      - name: Display results
        run: |
          echo "=== FINAL RESULTS ==="
          echo "Virgo models:"
          find public/models/virgo -name "*.glb" -exec basename {} \; | sort || echo "None"
          echo ""
          echo "ANYON_E models:"
          find public/models/anyon_e -name "*.glb" -exec basename {} \; | sort || echo "None"
          echo ""
          echo "Total GLB files: $(find public/models -name "*.glb" | wc -l)"
